name: Publish Canary

# Triggered when you push/force-push the "canary" tag
# From local: npm run publish:canary
on:
  push:
    tags:
      - 'canary'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          registry-url: https://registry.npmjs.org

      - run: npm ci

      - name: Determine canary version
        id: canary
        run: |
          # Get package name and base version from package.json
          PACKAGE=$(node -p "require('./package.json').name")
          BASE=$(node -p "require('./package.json').version.split('-')[0]")
          # Get highest existing canary number for this base version
          EXISTING=$(node -e "
            const versions = require('child_process').execSync('npm view $PACKAGE versions --json 2>/dev/null', {encoding:'utf8'});
            const list = JSON.parse(versions || '[]');
            const pattern = /^${BASE}-canary\.(\d+)$/;
            const numbers = list.map(v => pattern.exec(v)?.[1]).filter(Boolean).map(Number);
            console.log(numbers.length ? Math.max(...numbers) : 0);
          ")
          NEXT=$((EXISTING + 1))
          VERSION="${BASE}-canary.${NEXT}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Canary version: $VERSION"

      - name: Set canary version
        run: npm version ${{ steps.canary.outputs.version }} --no-git-tag-version

      - name: Publish to npm (canary tag)
        run: npm publish --tag canary
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Output version
        run: echo "Published ${{ steps.canary.outputs.version }}"
