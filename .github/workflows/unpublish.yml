name: Unpublish

# Triggered via GitHub CLI: gh workflow run unpublish.yml -f version=1.2.0-dev.20251227 -f type=dev
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to unpublish, or "all" for all versions of the specified type'
        required: true
        type: string
      type:
        description: 'Version type: dev, canary, or stable'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - canary
          - stable

jobs:
  unpublish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - name: Unpublish version(s)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          TYPE="${{ inputs.type }}"
          PACKAGE=$(node -p "require('./package.json').name")

          if [ "$VERSION" = "all" ]; then
            echo "Fetching all $TYPE versions..."
            
            if [ "$TYPE" = "dev" ]; then
              PATTERN="-dev\."
            elif [ "$TYPE" = "canary" ]; then
              PATTERN="-canary\."
            else
              # stable = versions without any prerelease suffix
              PATTERN="^[0-9]+\.[0-9]+\.[0-9]+$"
            fi
            
            ALL_VERSIONS=$(npm view $PACKAGE versions --json 2>/dev/null || echo "[]")
            
            if [ "$TYPE" = "stable" ]; then
              VERSIONS=$(echo "$ALL_VERSIONS" | node -e "
                const data = require('fs').readFileSync(0, 'utf8');
                const versions = JSON.parse(data);
                versions.filter(v => !v.includes('-')).forEach(v => console.log(v));
              ")
            else
              VERSIONS=$(echo "$ALL_VERSIONS" | grep -o "\"[^\"]*${PATTERN}[^\"]*\"" | tr -d '"' || echo "")
            fi
            
            if [ -z "$VERSIONS" ]; then
              echo "No $TYPE versions found."
              exit 0
            fi
            
            echo "Found $TYPE versions:"
            echo "$VERSIONS"
            echo ""
            
            for V in $VERSIONS; do
              echo "Unpublishing $V..."
              npm unpublish "$PACKAGE@$V" || echo "Failed to unpublish $V (might be older than 72 hours)"
            done
          else
            echo "Unpublishing $VERSION..."
            npm unpublish "$PACKAGE@$VERSION"
          fi

      - name: Summary
        run: |
          echo "## Unpublished Version(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Type: \`${{ inputs.type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Input: \`${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
